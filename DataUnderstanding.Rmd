---
title: Data Mining on a Dataset of 3.2 million grocery transactions for Market Basket
  Analysis
author: "Priyanka Ghule and Saurabh Chakrabarty"
date: "10 September 2017"
output:
  html_document:
    theme: cosmo
  pdf_document: default
---

#Motivation

We are living in a generation where data is everything. Every processes and businesses generate enormous amount of data. But they don't know what to do with all that data. Grocery is one of the most common transactions that major percentage of people perform on a daily basis. The best part of Grocery transactions from any supermarket/grocery store is that they generate data based on the transactions, on a daily basis. 

This data can be analyzed and multiple statistical models can be applied on such a huge dataset to understand some hidden patterns and buyer behaviours that are not visible to a common man. Many prediction models can also be used to predict the probability of buyer coming back and buying specific products. This, in turn, can help the businesses attract more sales and customer retention, by knowing what to market, where to market and when to market.

#Dataset Information

“The Instacart Online Grocery Shopping Dataset 2017”, Accessed from [Instacart Website](https://www.instacart.com/datasets/grocery-shopping-2017).

#Aim

From this Dataset, we intend to understand the following:

- Consumer behaviors in buying Online Groceries, Product movement analysis due to consumer orders & Department wise sales and association between multiple products and consumers.
- Visualization and Exploratory Data Analysis on the topics above.
- Test multiple models for predicting product behaviours like whether a User will buy again, Try for the first time or Add to Cart during next visit.

Such predictions and models can be applied to any other Supermarket/Grocery stores which stores all the Buyer transactions, in turn this will allow them to predict outstanding results from such Statistical analysis and predictions.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F)
```


## 1. Exploratory Data Analysis


This is an exploratory analysis of the above mentioned dataset.

This anonymized dataset contains a sample of over 3 million grocery orders from more than 200,000 Instacart users.

For each user, they provide between 4 and 100 of their orders, with the sequence of products purchased in each order. They also provide the week and hour of day the order was placed, and a relative measure of time between orders.

We will use this data to test models for predicting products that a user will buy again, try for the first time or add to cart next during a session.

The dataset consists of information about 3.4 million grocery orders, distributed across 6 csv files. 

```{r load_data}
#orders <- read_csv('../input/orders.csv')
#orders <- as.data.table(orders)
```

```{r message=FALSE, results='hide', warning=FALSE}
library(readr)          # To read data
library(data.table)     # For data manipulation
library(ggplot2)        # For plotting
library(gridExtra)      # To arrange ggplots
library(scales)         # To adjust numeric scales in ggplots
library(dplyr)          # To use pipes?
library(knitr)          # For Dynamic Report Generation
library(stringr)        # For string manupulation
library(DT)             # A Data Table library

orders <- fread('../Input/orders.csv')
products <- fread('../Input/products.csv')
order_products <- fread('../Input/order_products__train.csv')
order_products_prior <- fread('../Input/order_products__prior.csv')
aisles <- fread('../Input/aisles.csv')
departments <- fread('../Input/departments.csv')

```


```{r include=FALSE}
options(tibble.width = Inf)
```


Lets first have a look at these files:

### Peek at the dataset {.tabset}

#### orders

This file gives a list of all orders we have in the dataset. 1 row per order. 
For example, we can see that user 1 has 11 orders, 1 of which is in the train set, and 10 of which are prior orders. The orders.csv doesn't tell us about which products were ordered. This is contained in the order_products.csv

```{r, result='asis'}
kable(head(orders,12))
glimpse(orders)
```


#### order_products_train

This file gives us information about which products (product_id) were ordered. It also contains information of the order (add_to_cart_order) in which the products were put into the cart and information of whether this product is a re-order(1) or not(0).

For example, we see below that order_id 1 had 8 products, 4 of which are reorders.

Still we don't know what these products are. This information is in the products.csv

```{r}
kable(head(order_products,10))
glimpse(order_products)
```

#### products

This file contains the names of the products with their corresponding product_id. Furthermore the aisle and deparment are included.

```{r}
kable(head(products,10))
glimpse(products)
```

#### order_products_prior

This file is structurally the same as the other_products_train.csv. 

```{r, result='asis'}
kable(head(order_products_prior,10))
glimpse(order_products_prior)
```


#### aisles

This file contains the different aisles.

```{r, result='asis'}
kable(head(aisles,10))
glimpse(aisles)
```

#### departments

```{r, result='asis'}
kable(head(departments,10))
glimpse(departments)
```

```{r message=FALSE, warning=FALSE}
orders <- orders %>% mutate(order_hour_of_day = as.numeric(order_hour_of_day), eval_set = as.factor(eval_set))
orders <- as.data.table(orders)
products <- products %>% mutate(product_name = as.factor(product_name),
                                aisle_id = as.integer(aisle_id),
                                department_id = as.integer(department_id))
aisles <- aisles %>% mutate(aisle = as.factor(aisle))
departments <- departments %>% mutate(department = as.factor(department))
```


### 1. Days Since Prior Order

The below is a distribution of the days since prior order.

Some observations:

- There are a number of people who make orders on the same day (0 days)
- There are lots of people who make orders on a weekly basis (7 days)
- There are some people who make orders every fortnight (14 days)
- There are yet some people who make orders every 3 weeks (21 days)
- 30 days appears to represent either:
  + People making orders monthly
  + Orders made 30 or more days apart

```{r warning=FALSE}
ggplot(orders, aes(x = days_since_prior_order)) +
  geom_bar(fill = c("pink", rep("grey25", 6), 
                    "pink", rep("grey25", 6), 
                    "pink", rep("grey25", 6),
                    "pink", rep("grey25", 6),
                    "pink", "grey50", "pink")) +
  theme_minimal() +
  theme(axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank()) +
  labs(x = "Days Since Prior Order",
       y = "Count",
       title = "Distribution of Orders by Days Since Prior Order") +
  scale_y_continuous(labels = comma)
```

### 2. Days Since Prior Order & Day of Week

Splitting the order data by day of week presents deviations from the overall pattern
shown above.

We can now start to see sub-populations in the data.

It appears that people who order on days 0 and 1 have  a tendency  to order 
7 days apart. This shows a population with a habbit of purchasing on the same 
day each week.

This pattern is not so pronounced  during days 2 - 4, though there is again for 
days 5 and 6. 

```{r warning=FALSE}
## Facet using grid.arrange for greater control of layout and colours

po0 <- ggplot(orders[order_dow == 0, ], aes(x = days_since_prior_order)) +
  geom_bar(fill = c(rep("grey25", 7), "orange", rep("grey25", 6), "orange",
                    rep("grey25", 6), "orange", rep("grey25", 6), "orange",
                    rep("grey25", 2))) +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  labs(y = "Day 0")

po1 <- ggplot(orders[order_dow == 1, ], aes(x = days_since_prior_order)) +
  geom_bar(fill = c(rep("grey25", 7), "orange", rep("grey25", 6), "orange",
                    rep("grey25", 6), "orange", rep("grey25", 6), "orange",
                    rep("grey25", 2))) +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  labs(y = "Day 1")

po2 <- ggplot(orders[order_dow == 2, ], aes(x = days_since_prior_order)) +
  geom_bar(fill = c(rep("grey25", 7), "orange",  rep("grey25", 6), "orange", "orange",
                    rep("grey25", 6), "orange", rep("grey25", 6), "orange",
                    rep("grey25", 1))) +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  labs(y = "Day 2")

po3 <- ggplot(orders[order_dow == 3, ], aes(x = days_since_prior_order)) +
  geom_bar(fill = c(rep("grey25", 2), "orange",  rep("grey25", 28))) +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  labs(y = "Day 3")

po4 <- ggplot(orders[order_dow == 4, ], aes(x = days_since_prior_order)) +
  geom_bar(fill = c(rep("grey25", 3), "orange",  rep("grey25", 3), "orange",
                    rep("grey25", 23))) +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  labs(y = "Day 4")

po5 <- ggplot(orders[order_dow == 5, ], aes(x = days_since_prior_order)) +
  geom_bar(fill = c(rep("grey25", 4), "orange",  rep("grey25", 2), "orange",
                    rep("grey25", 23))) +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  labs(y = "Day 5")

po6 <- ggplot(orders[order_dow == 6, ], aes(x = days_since_prior_order)) +
  geom_bar(fill = c(rep("grey25", 6), "orange", "orange",  rep("grey25", 5), "orange",
                    rep("grey25", 6), "orange", rep("grey25", 6), "orange",
                    rep("grey25", 3))) +
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  labs(y = "Day 6",
       x = "Day Since Last Order")

grid.arrange(po0, po1, po2, po3, po4, po5, po6,
           ncol = 1)
```

### 3. Order Hour of Day when orders on the same day {.tabset}

There are a sizeable number of orders that happen on the same day, represented
by days_since_prior_order == 0. This raises some questions:

- When are they making the second order for the day?
- How many hours apart are they making orders if ordered on the same day?

#### When is the second order?

```{r warning=FALSE}
# Select orders where days_since_prior_order == 0
ggplot(orders[as.numeric(orders$days_since_prior_order) == 0, ], 
       aes(x = order_hour_of_day)) +
  geom_bar() +
  theme_minimal() +
  theme(axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank()) +
  labs(x = "Hour of Day",
       y = "",
       title = "Hour of day when days since prior order = 0")
```

#### How far apart?

If someone is ordering on the same day, they are mostly ordering within the same
hour, or shortly after their first order. Good thing they noticed soon after
their original order!

```{r warning=FALSE}
## Calculate hours since prior order, only if days since prior order is 0
orders <- data.table(orders)
temp <- orders$order_hour_of_day
temp <- c("24", temp)
temp <- temp[1:length(temp)-1]
orders$temp <- temp
orders[, hours_since_last_order := as.numeric(order_hour_of_day) - as.numeric(temp)]
orders[days_since_prior_order != 0 | is.na(days_since_prior_order), 
       hours_since_last_order := NA]
temp <- orders[days_since_prior_order == 0, ]

ggplot(temp, aes(x = hours_since_last_order)) +
  geom_bar() +
  theme_minimal() +
  theme(axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank()) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(x = "Hours Since Last Order",
       y = "",
       title = "Hours Since Last Order if Ordered on the Same Day")
```

## 4. Orders by Day of the Week

There are a lot of orders on each day of the week. However, there are 
significantly more orders on days 0 and 1. 

Could this represent the weekend?

```{r warning=FALSE, orders_day_of_week}

ggplot(orders, aes(x = order_dow)) + 
  geom_bar(fill = c(rep("gold", 2), rep("grey25", 5))) +
  theme_minimal() +
  theme(axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank()) +
  labs(x = "Day of Week (unknown)",
       y = "Count",
       title = "Distribution of Orders by Day of Week") +
  scale_y_continuous(labels = comma)

```


## 5. Orders by Hour of the Day

Here we can see at what hours of the day people are making orders.

Reading the plot from left to right:

- There are few orders between 00 - 05, representing few orders during sleeping hours
- Orders pick up beginnig at hour 06 as people start to wake up
- Orders continue to pick up rapidly in the morning, peaking at hour 10 (gold)
- Orders continue to be made during the morning, experiencing a small dip at noon
- There is a slight pick up of orders just after lunch at hour 15
- Orders begin to drop commencing at hour 16 through to hour 23

```{r warning=FALSE, orders_hour_of_day}
ggplot(orders, aes(x = order_hour_of_day)) + 
  geom_bar(fill = c(rep("grey25", 10), "gold", rep("grey25", 4), "cyan3",
                    rep("grey25", 8))) +
  theme_minimal() +
  theme(axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank()) +
  labs(x = "Hour of the Day",
       y = "",
       title = "Distribution of Orders by Hour of the Day") +
  scale_y_continuous(labels = comma)

```

So most orders are made between the hours 09 and 16. But does this pattern exist
over all days of the week?

### 6. Order by Hour and Day of Week

In the graph below, the pattern we observed is no longer observed.

Instead, Day 1 to Day 5 has hour 10 as the most popular hour for orders, while
days 0 and 6 have hour 14 as the most popular. It suggests to me that Days 1 - 5
are weekdays, while Days 0 and 6 are weekends.

```{r warning=FALSE, hour_and_dow}
# ggplot(orders, aes(x = order_hour_of_day)) +
#   geom_bar() +
#   theme_minimal() +
#   theme(axis.ticks.x = element_blank(),
#         axis.ticks.y = element_blank(),
#         axis.text.y = element_blank(),
#         legend.position = "none",
#         panel.grid.major = element_blank()) +
#   labs(x = "Hour of Day",
#        y = "",
#        title = "Distribution of Orders by Hour of Day") +
#   facet_grid(order_dow ~ .)

p0 <- ggplot(orders[order_dow == 0, ], aes(x = order_hour_of_day)) +
  geom_bar(fill = c(rep("grey25", 14), "gold", rep("grey25", 9))) +
  theme_minimal() +
  theme(axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank()) +
  labs(y = "Day 0")

p1 <- ggplot(orders[order_dow == 1, ], aes(x = order_hour_of_day)) +
  geom_bar(fill = c(rep("grey25", 10), "gold", rep("grey25", 13))) +
  theme_minimal() +
  theme(axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank()) +
  labs(y = "Day 1")

p2 <- ggplot(orders[order_dow == 2, ], aes(x = order_hour_of_day)) +
  geom_bar(fill = c(rep("grey25", 10), "gold", rep("grey25", 13))) +
  theme_minimal() +
  theme(axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank()) +
  labs(y = "Day 2")

p3 <- ggplot(orders[order_dow == 3, ], aes(x = order_hour_of_day)) +
  geom_bar(fill = c(rep("grey25", 10), "gold", rep("grey25", 13))) +
  theme_minimal() +
  theme(axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank()) +
  labs(y = "Day 3")

p4 <- ggplot(orders[order_dow == 4, ], aes(x = order_hour_of_day)) +
  geom_bar(fill = c(rep("grey25", 10), "gold", rep("grey25", 13))) +
  theme_minimal() +
  theme(axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank()) +
  labs(y = "Day 4")

p5 <- ggplot(orders[order_dow == 5, ], aes(x = order_hour_of_day)) +
  geom_bar(fill = c(rep("grey25", 10), "gold", rep("grey25", 13))) +
  theme_minimal() +
  theme(axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank()) +
  labs(y = "Day 5")

p6 <- ggplot(orders[order_dow == 6, ], aes(x = order_hour_of_day)) +
  geom_bar(fill = c(rep("grey25", 14), "gold", rep("grey25", 9))) +
  theme_minimal() +
  theme(axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank()) +
  labs(y = "Day 6",
       x = "Hour of the Day")



grid.arrange(p0, p1, p2, p3, p4, p5, p6, ncol = 1)

```

### 7. Most often reordered Products
Now here it becomes really interesting. These 10 products have the highest probability of being reordered.

```{r warning=FALSE, fig.height=5.5}
tmp <-order_products %>% 
  group_by(product_id) %>% 
  summarize(proportion_reordered = mean(reordered), n=n()) %>% 
  filter(n>40) %>% 
  top_n(10,wt=proportion_reordered) %>% 
  arrange(desc(proportion_reordered)) %>% 
  left_join(products,by="product_id")

kable(tmp)

tmp %>% 
  ggplot(aes(x=reorder(product_name,-proportion_reordered), y=proportion_reordered))+
  geom_bar(stat="identity",fill="grey25")+
  theme(axis.text.x=element_text(angle=90, hjust=1),axis.title.x = element_blank())+coord_cartesian(ylim=c(0.85,0.95))
```


### 8. Which item do people put into the cart first?
People seem to be quite certain about Multifold Towels and if they buy them, put
them into their cart first in 66% of the time.
```{r message=FALSE, fig.height=5.5}
tmp <- order_products %>% 
  group_by(product_id, add_to_cart_order) %>% 
  summarize(count = n()) %>% mutate(pct=count/sum(count)) %>% 
  filter(add_to_cart_order == 1, count>10) %>% 
  arrange(desc(pct)) %>% 
  left_join(products,by="product_id") %>% 
  select(product_name, pct, count) %>% 
  ungroup() %>% 
  top_n(10, wt=pct)

kable(tmp)

tmp %>% 
  ggplot(aes(x=reorder(product_name,-pct), y=pct))+
  geom_bar(stat="identity",fill="grey25")+
  theme(axis.text.x=element_text(angle=90, hjust=1),axis.title.x = element_blank())+coord_cartesian(ylim=c(0.4,0.7))

```

### 9. Visualizing the Product Portfolio
Here is use to treemap package to visualize the structure of instacarts product portfolio. In total there are 21 departments containing 134 aisles. 

```{r}
library(treemap)
is.character(products$aisle_id)
is.integer(aisles$aisle_id)

tmp <- products %>% group_by(department_id, aisle_id) %>% summarize(n=n())
tmp <- tmp %>% left_join(departments,by="department_id")
tmp <- tmp %>% left_join(aisles,by="aisle_id")

tmp2<-order_products %>% 
  group_by(product_id) %>% 
  summarize(count=n()) %>% 
  left_join(products,by="product_id") %>% 
  ungroup() %>% 
  group_by(department_id,aisle_id) %>% 
  summarize(sumcount = sum(count)) %>% 
  left_join(tmp, by = c("department_id", "aisle_id")) %>% 
  mutate(onesize = 1)

is.integer(departments$department_id)

```

#### 9.1 How are aisles organized within departments?
```{r, fig.width=9, fig.height=6}
treemap(tmp2,index=c("department","aisle"),vSize="onesize",vColor="department",palette="Set3",title="",sortID="-sumcount", border.col="#FFFFFF",type="categorical", fontsize.legend = 0,bg.labels = "#FFFFFF")
```

#### 9.2 How many unique products are offered in each department/aisle?
The size of the boxes shows the number of products in each category. 
```{r, fig.width=9, fig.height=6}
treemap(tmp,index=c("department","aisle"),vSize="n",title="",palette="Set3",border.col="#FFFFFF")
```

#### 9.3 How often are products from the department/aisle sold?
The size of the boxes shows the number of sales. 
```{r, fig.width=9, fig.height=6}
treemap(tmp2,index=c("department","aisle"),vSize="sumcount",title="",palette="Set3",border.col="#FFFFFF")
```